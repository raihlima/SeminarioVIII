<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Jogo 01</title>
    <script src="BarraStatus.js"></script>
    <script src="Foguete.js"></script>
    <script src="Inimigo.js"></script>
    <script src="Tiro.js"></script>
    <script src="Item.js"></script>
  </head>
  <body>
    <h1>Jogo 02</h1>
    <canvas id="canvas" width="700" height="500"></canvas>
    <script>
      var canvas = document.getElementsByTagName("canvas")[0];
      var ctx = canvas.getContext("2d");
      var dt = anterior = 0;

    //  var fogueteSelecionado = 0;
      var foguete  = 0;
      var barra = new BarraStatus();
      var inimigo = [];
      //var contInimigoMortos = 0;
      var cadenciaInimigo = 10;

      var item = [];

      var imunidade = 10;

      //Tiros
      var tiroNave = [];
      var tiroInimigo = [];
      var cadencia = 1;

      //Tela
      var cenario = 0;

      //Ponto obtido durante o Jogo
      var pontoMax = 0;
      var pontoAtual = 0;

      var controleTempo = 0;

      //Trocar de fase
      function trocaFase(){
        this.fase += 1;

        //Tela de fase
        //this.pontoAtual += Math.trunc(foguete.combustivel);
        inimigo.x = Math.floor(Math.random() * 600);
        foguete.resetar();
      }

      function atualizar(t){
        if(cenario == 0){
          ctx.fillStyle = "black";
          ctx.fillRect(0,0, canvas.width, canvas.height);

          ctx.font = '70pt Arial';
          ctx.fillStyle = "wheat";
          ctx.textAlign = "center";
          ctx.fillText("Space Shooter", 350, 150);
          ctx.font = '20pt Arial';
          ctx.fillText("Pressione qualquer tecla para continuar", 350, 470);

          requestAnimationFrame(atualizar);


        } else if (cenario == 1){

          ctx.fillStyle = "black";
          ctx.fillRect(0,0, canvas.width, canvas.height);

          ctx.textAlign = "center";
          ctx.font = '50pt Arial';
          ctx.fillStyle = "wheat";
          ctx.fillText("Selecione a nave", 350, 150);
          ctx.font = '30pt Arial';

          ctx.textAlign = "start";

          //Naves
          if(foguete == 0){
            ctx.fillStyle = "white";
            ctx.fillRect(90,290, 50, 50);
          }  else if(foguete==1){
            ctx.fillStyle = "white";
            ctx.fillRect(290,290, 50, 50);
          }  else if(foguete==2){
            ctx.fillStyle = "white";
            ctx.fillRect(490,290, 50, 50);
          }

          ctx.fillStyle = "green";
          ctx.fillText("Verde", 70, 450);
          ctx.fillRect(100,300, 30, 30);
          ctx.fillStyle = "wheat";
          ctx.fillText("Areia", 270, 450);
          ctx.fillRect(300,300, 30, 30);
          ctx.fillStyle = "teal";
          ctx.fillText("Teal", 470, 450);
          ctx.fillRect(500,300, 30, 30);

          requestAnimationFrame(atualizar);

        } else if (cenario == 2){

          dt = (t - anterior)/1000;

          //Desenhar o fundo
          ctx.fillStyle = "black";
          ctx.fillRect(0,0, canvas.width, canvas.height);

          //Tiro da Nave
          for(var i=0;i<tiroNave.length;i++){
            tiroNave[i].desenhar(ctx);
            tiroNave[i].atualizar(dt);

            //Verifica se saiu da Tela
            if(tiroNave[i].verificaSaidaTela()==true || tiroNave[i].color=="darkblue"){
              tiroNave.splice(i,1);
              break;
            }
          }
          cadencia+=0.1;
          cadenciaInimigo+=0.04 ;

          //Funções para inimigos
          for(var i = 0;i<inimigo.length;i++){
            inimigo[i].desenhar(ctx);
            inimigo[i].mover(dt);

            //verifica se inimigo saiu da tela ou acabou a energia
            if(inimigo[i].verificaSaida()==true){
              inimigo.splice(i,1);
              break;
            } else if(inimigo[i].verificaMorte()==true){
              var random = Math.random()*100;
              if(random<18){
                item.push(new Item(inimigo[i].x,inimigo[i].y));
              }
              pontoAtual+=8;
              inimigo.splice(i,1);
              break;

            }

            //verifica cadencia de tiro inimigo e atira
            if(inimigo[i].cadencia>=2){
              tiroInimigo.push(new Tiro(1,inimigo[i],0))
              inimigo[i].cadencia=0;
            }
          }

          //Atira os misseis inimigos
          for(var j=0; j<tiroInimigo.length;j++){
            //Desenha os misseis
            tiroInimigo[j].desenhar(ctx);
            tiroInimigo[j].atualizar(dt);

            //verifica se tiro saiu da Tela
            if(tiroInimigo[j].verificaSaidaTela()==true || tiroInimigo[j].color=="darkblue"){
              tiroInimigo.splice(j,1);
              break;
            }
          }
          //Teste Colisao Tiros
          for(var i = 0; i<tiroNave.length; i++){
            for(var j=0; j<inimigo.length; j++){

              if(tiroNave[i].verificaColisao(inimigo[j])){
                inimigo[j].energia-=1;
                this.pontoAtual+=1;

                //tiroNave.splice(i,1);
                //tiroNave[i].ativo=false;
              };
            }
          }

          //Teste colisao tiro Inimigo
          for(var i = 0; i<tiroInimigo.length;i++){
            if(imunidade>=10){
              if(tiroInimigo[i].verificaColisao(foguete)==true){
                foguete.energia-=25;
                imunidade=0;
                }
            }
          }

          //Teste colisao
          foguete.atualizar(dt);
          for(var i =0; i<inimigo.length;i++){
            if(imunidade>=10){
              if(foguete.colisao(inimigo[i])){
                imunidade=0;
                foguete.energia-=25;
              }

            }
          }

        //Funções para itens
        for(var i=0;i<item.length;i++){
          item[i].desenhar(ctx);
          item[i].mover(dt);
        }

        //Pegar Item
        for(var i=0;i<item.length;i++){
          if(item[i].verificaColisao(foguete)==true){
            if(item[i].id==0){
              imunidade = -60;
              item.splice(i,1);
              break;
            } else if(item[i].id==1){
              pontoAtual += 50;
              item.splice(i,1);
              break;
            } else if (item[i].id==2){
              foguete.quantidadeTiro+=1;
              item.splice(i,1);
              break;
            } else if( item[i].id==3){
              for(var j =0;j<inimigo.length;j++){
                inimigo[j].energia=-1;
              }
              item.splice(i,1);
              break;

            } else if( item[i].id==4){
              foguete.vida+=1;
              item.splice(i,1);
              break;
          }
        }
      }

        //  foguete.mover(dt);

        //Imunidade temporaria

        if(this.imunidade<=10){
          this.imunidade+=0.1;
        }
        if(Math.abs(Math.trunc(this.imunidade)%2) ==1){
          foguete.color="yellow";
        } else {
          foguete.color = foguete.corOriginal;
        }

        //Controle de Vidas
        if(foguete.energia==0){
          foguete.vida-=1;
          foguete.energia=100;
          imunidade=0;
        }

        //Para tela de game over
        if(foguete.vida<1){
          cenario=3;
        }

          //Desenhar o Foguete, Barra e a Inimigo
          foguete.desenhar(ctx);
          barra.desenhar(ctx, foguete.getVida(), this.pontoAtual, foguete.energia);
          criarInimigos();


          anterior = t;
          requestAnimationFrame(atualizar);
        } else if (cenario ==3){
          //Tela de Game Over
          ctx.fillStyle = "black";
          ctx.fillRect(0,0, canvas.width, canvas.height);

          //Texto Game Over
          ctx.fillStyle = "wheat";
          ctx.font = '70pt Arial';
          ctx.fillText("GAME OVER", 70, 150);
          ctx.fillText("Pontuação", 130, 321);
          ctx.fillText(pontoAtual, 320, 421);

          anterior = t;
          requestAnimationFrame(atualizar);
        }

      }

      function criarInimigos(){
        if(cadenciaInimigo>3){
          inimigo.push(new Inimigo(pontoAtual/200));
          cadenciaInimigo=0;
        }

      }


      addEventListener("keydown", function (e) {
    switch (e.keyCode) {
      case 13://Enter
        if(cenario==1){
          cenario = 2;
          foguete= new Foguete (foguete);
          foguete.resetar();
          foguete.vida=3;
        } else if(cenario==3){
          cenario =2;
        }
        case 32://Espaço
          if(cenario==2){
            if(cadencia>1){
              if(foguete.quantidadeTiro==1){
                tiroNave.push(new Tiro(0,foguete,0));
                cadencia=0;
              } else if(foguete.quantidadeTiro==2){
                tiroNave.push(new Tiro(0,foguete,1));
                tiroNave.push(new Tiro(0,foguete,2));
                cadencia=0;

              } else {
                tiroNave.push(new Tiro(0,foguete,0));
                tiroNave.push(new Tiro(0,foguete,1));
                tiroNave.push(new Tiro(0,foguete,2));
                cadencia=0;
              }
            }
            break;
          }
        case 37: //Botão Esquerdo
          if(cenario == 1){
            if(foguete ==2 || foguete ==1){
              foguete-=1;
              break;
            }
          }
          if(cenario==2){
            foguete.vx = -250;
            break;
          }
          break;
        case 39: //Botão Direito
        if(cenario == 1){
          if(foguete == 0 || foguete == 1){
            foguete += 1;
          }
        }
        if(cenario==2){
            foguete.vx =250;
            break;
          }
          break;
        case 38: //Botão Cima
        if(cenario==2){
            foguete.vy=-250;
            break;
          }
        case 40: //Botão Baixo
          if(cenario==2){
              foguete.vy=250;
              break;
          }
        default:
          if(cenario==0){
            cenario=1;
          }  else if(cenario==3){
              cenario=2;
              foguete.vida=3;
              foguete.resetar();
          }
    }
});
addEventListener("keyup", function (e) {
    switch (e.keyCode) {
        case 37: //Botão Esquerdo

          if(cenario==2){
            foguete.vx = 0;
          } //-100*fase/2;
            break;
        case 39: //Botão Direito

        if(cenario==2){
            foguete.vx = 0;
          } //-100*fase/2;
            break;
        case 38: //Botão Cima

        if(cenario==2){
            foguete.vy = 0;
          }
            break;
        case 40: //Botão Baixo
              if(cenario==2){
                  foguete.vy=0;
                  break;
              }
        default:
          if(cenario==0){
          cenario=1;
          } else if(cenario==3){
            foguete.vida=3;
            foguete.resetar();
            fase=1;
            pontoAtual=0;
            pontoMax=0;
              cenario=2;
          }
    }
});


      requestAnimationFrame(atualizar);
    </script>
  </body>
</html>
